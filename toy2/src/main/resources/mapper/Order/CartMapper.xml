<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fastcampus.dao.CartMapper">
    <sql id="selectFromCart">
        SELECT cart_id, mbr_id, nm_id, crt_st
        FROM cart
    </sql>

    <!-- 전체 장바구니 수 확인  -->
    <!--  장바구니 번호 만들때 사용도 가능  -->
    <select id="count" resultType="int">
        SELECT count(*)
        FROM cart
    </select>

<!--  CRUD 작성  -->
<!--
  1. 장바구니에서 가장 필요한 작업은 Insert, Update
    - 장바구니에 담길 때 insert작업이 필요
    - 장바구니가 삭제될 때 실제로 삭제하는 것이 아닌 장바구니의 상태를 변경해주기 위해 update작업이 필요

  2. 장바구니는 그냥 생성되는 것이 아닌
    회원이 상품을 장바구니가 먼저 생성되고 장바구니 번호를 반환하며 반환한 장바구니 번호를 이용하여 장바구니_상품 테이블에서 Key로 사용해야 됨
  -->

<!--
    장바구니 번호를 반환해서 바로 장바구니_상품 테이블에 insert할 때 이용해야 되므로 useGeneratedKey=true로 설정하고 keyProperty="cart_id"를 반환
    장바구니 내의 상품 중 하나라도 주문이 완료되는 경우 기존의 장바구니의 상태를 비활성화 하고, 새로운 장바구니로 담아주어야 됨
  -->
    <insert id="insert" parameterType="CartDto" useGeneratedKeys="true" keyProperty="cart_id">
        INSERT INTO cart(cart_id, mbr_id, nm_id, crt_st, create_id)
        <if test="mbr_id != null">
            VALUES (#{cart_id}, #{mbr_id}, #{nm_id}, #{crt_st}, #{mbr_id})
        </if>
        <if test="nm_id != null">
            VALUES (#{cart_id}, #{mbr_id}, #{nm_id}, #{crt_st}, #{nm_id})
        </if>
    </insert>

    <!--기존의 장바구니가 사라지고 새로운 장바구니를 추가하는 경우 기존의 장바구니의 상태는 비활성화-->
    <update id="update" parameterType="CartDto">
        UPDATE cart
        SET cart_id = #{cart_id},
        <if test="mbr_id != null">
            mbr_id = #{mbr_id},
        </if>
        <if test="nm_id != null">
            nm_id = #{nm_id},
        </if>
            crt_st = #{crt_st}
    </update>

    <!-- 전체 삭제  -->
    <delete id="deleteAll">
        DELETE FROM cart
    </delete>

    <!--  회원들의 장바구니 수 확인  -->
    <select id="countMember" resultType="int">
        SELECT count(*)
        FROM cart
        WHERE mbr_id IS NOT NULL
    </select>

    <!-- 비회원들의 장바구니 수 확인  -->
    <select id="countNoMember" resultType="int">
        SELECT count(*)
        FROM cart
        WHERE nm_id IS NOT NULL
    </select>

</mapper>